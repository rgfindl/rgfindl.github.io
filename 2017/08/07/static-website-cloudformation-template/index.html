<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Static Website CloudFormation Template | Randy Findley</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2017/08/07/static-website-cloudformation-template/">Static Website CloudFormation Template</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">August 07 2017</p>
  </section>

  <section class="article-entry">
    <p>The template: <a href="http://thestackshack.s3-website-us-east-1.amazonaws.com/static.website.cloudformation.json" target="_blank" rel="external">static.website.cloudformation.json</a></p>
<h3 id="Click-here-to-launch-your-static-website-on-AWS"><a href="#Click-here-to-launch-your-static-website-on-AWS" class="headerlink" title="Click here to launch your static website on AWS"></a>Click here to launch your static website on AWS</h3><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=staticwebsite&templateURL=https://s3.amazonaws.com/thestackshack/static.website.cloudformation.json" target="_blank" rel="external"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a>
<h3 id="What-is-a-static-website-and-why-are-they-cool"><a href="#What-is-a-static-website-and-why-are-they-cool" class="headerlink" title="What is a static website and why are they cool?"></a>What is a static website and why are they cool?</h3><p>A static website is simply html, css, js,… files hosted by AWS S3.  They are cool because there are no servers for you to maintain and pay for.  You only pay for the storage of your files and the amount of traffic your site gets.  Security is greatly improved because your site has no servers or databases to hack into.</p>
<h3 id="What-AWS-resources-does-this-template-use"><a href="#What-AWS-resources-does-this-template-use" class="headerlink" title="What AWS resources does this template use?"></a>What AWS resources does this template use?</h3><ul>
<li>S3 (File storage &amp; static website)</li>
<li>CloudFront (HTTPS &amp; caching)</li>
<li>Certificate Manager (SSL Cert)</li>
<li>Route53 (DNS)</li>
<li>CodeBuild (Continuous deployment)</li>
<li>CodePipeline (Continuous deployment)</li>
<li>CodeCommit (GIT repo)</li>
<li>CloudFormation (Infrastructure as Code)</li>
<li>IAM (AWS permissions &amp; users)</li>
</ul>
<p>This seems like a lot just to host a static website!  Yep, it is, that’s why I created this handy CloudFormation template so the next time I want to stand up a <em>simple</em> static website I just have to click the button above.</p>
<h3 id="How-do-I-get-started"><a href="#How-do-I-get-started" class="headerlink" title="How do I get started?"></a>How do I get started?</h3><h4 id="Step-1-Create-your-AWS-account"><a href="#Step-1-Create-your-AWS-account" class="headerlink" title="Step 1 - Create your AWS account"></a>Step 1 - Create your AWS account</h4><p>The first step is to create an <a href="https://aws.amazon.com" target="_blank" rel="external">AWS account</a>.</p>
<h4 id="Step-2-Create-your-IAM-user"><a href="#Step-2-Create-your-IAM-user" class="headerlink" title="Step 2 - Create your IAM user"></a>Step 2 - Create your IAM user</h4><p>Once you’re logged into your account you need to create an <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="external">IAM user</a> with <strong>Programmatic access</strong>, and with <strong>AWSCodeCommitFullAccess</strong> &amp; <strong>AdministratorAccess</strong> permissions.  Also, your user will need CodeCommit (GIT) credentials.  Don’t forget to download all of your credentials because you’ll need then later.  See the screen shots below:<br><img src="/images/aws-permissions.png"><br><img src="/images/aws-git-credentials.png"></p>
<h4 id="Step-3-Purchase-your-domain-name"><a href="#Step-3-Purchase-your-domain-name" class="headerlink" title="Step 3 - Purchase your domain name"></a>Step 3 - Purchase your domain name</h4><p>Head on over to <a href="https://console.aws.amazon.com/route53/home" target="_blank" rel="external">Route 53</a> and register your domain name.  If you already have a domain name, don’t worry, you can point it at Route53 after you build the stack.</p>
<h4 id="Step-4-Build-the-stack"><a href="#Step-4-Build-the-stack" class="headerlink" title="Step 4 - Build the stack"></a>Step 4 - Build the stack</h4><p>Click on the buttom at the top to build the stack.  Use your domain name and app name as the input parameters.</p>
<p>You can also copy the cloudformation template and install the stack using the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" target="_blank" rel="external">AWS command-line tools</a>.  Harder but recommended.  You should really version control your IaC template as well as your code.  Here are the commands to create, update, and delete the stack.</p>
<p><strong>Create Stack</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">aws cloudformation create-stack \</div><div class="line">--stack-name &lt;example-com&gt; \</div><div class="line">--template-body file:///&lt;abs_path&gt;/static.website.cloudformation.json \</div><div class="line">--parameters ParameterKey=ApexDomainName,ParameterValue=&lt;example.com&gt; ParameterKey=AppName,ParameterValue=&lt;example&gt; \</div><div class="line">--tags=Key=app,Value=&lt;example.com&gt; \</div><div class="line">--capabilities CAPABILITY_IAM \</div><div class="line">--profile &lt;profile&gt;</div></pre></td></tr></table></figure></p>
<p><strong>Delete Stack</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">aws cloudformation delete-stack \</div><div class="line">--stack-name &lt;example-com&gt; \</div><div class="line">--profile &lt;profile&gt;</div></pre></td></tr></table></figure></p>
<p><strong>Update Stack</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">aws cloudformation update-stack \</div><div class="line">--stack-name &lt;example-com&gt; \</div><div class="line">--template-body file:///&lt;abs_path&gt;/static.website.cloudformation.json \</div><div class="line">--parameters ParameterKey=ApexDomainName,ParameterValue=&lt;example.com&gt; ParameterKey=AppName,ParameterValue=&lt;example&gt; \</div><div class="line">--tags=Key=app,Value=&lt;example.com&gt; \</div><div class="line">--capabilities CAPABILITY_IAM \</div><div class="line">--profile &lt;profile&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Step-5-Validate-domain-ownership"><a href="#Step-5-Validate-domain-ownership" class="headerlink" title="Step 5 - Validate domain ownership"></a>Step 5 - Validate domain ownership</h4><p>When AWS Certificate Manager creates your SSL certificate it sends and email to the domain name administrator (You).  You have to get that email and click the confirmation link.  Once this step has been completed the stack can continue being built.  More information can be found here:  <a href="http://docs.aws.amazon.com/acm/latest/userguide/gs-acm-validate.html" target="_blank" rel="external">http://docs.aws.amazon.com/acm/latest/userguide/gs-acm-validate.html</a></p>
<h4 id="Step-6-Wait-for-your-stack-to-be-built"><a href="#Step-6-Wait-for-your-stack-to-be-built" class="headerlink" title="Step 6 - Wait for your stack to be built"></a>Step 6 - Wait for your stack to be built</h4><p>Check the progress of your stack here:  <a href="https://console.aws.amazon.com/cloudformation/home" target="_blank" rel="external">https://console.aws.amazon.com/cloudformation/home</a></p>
<p>Once your stack has been built copy the output param which will be your CodeCommit repo URL.  </p>
<h3 id="What-do-I-do-after-my-stack-has-been-created"><a href="#What-do-I-do-after-my-stack-has-been-created" class="headerlink" title="What do I do after my stack has been created?"></a>What do I do after my stack has been created?</h3><p>Use your CodeCommit repo and your CodeCommit credentials to start checking in your static site.</p>
<p>CodePipeline and CodeBuild are setup to continuously deploy your site as you push changes to your repo.  </p>
<p>Branches and CodePipeline actions:<br><strong>master</strong> -&gt; Pushes changes to APEX <example.com> (yes ssl)<br><strong>develop</strong> -&gt; Pushes changes to dev subdomain (no ssl)</example.com></p>
<h3 id="What-should-the-structure-of-my-project-be"><a href="#What-should-the-structure-of-my-project-be" class="headerlink" title="What should the structure of my project be?"></a>What should the structure of my project be?</h3><p>Great question.  You need to add a buildspec.yml so CodeBuid knows how to build your project.  </p>
<p>/www/assets/ -&gt; Put all js, css, images, etc… in this folder.<br>/www/index.html -&gt; Put all html files in this folder.<br>buildspec.yml -&gt; CodeBuild uses this to build your project.</p>
<p>buildspec.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">version: 0.1</div><div class="line">phases:</div><div class="line">  install:</div><div class="line">    commands:</div><div class="line">  pre_build:</div><div class="line">    commands:</div><div class="line">  build:</div><div class="line">    commands:</div><div class="line">      - aws s3 sync www &quot;s3://$&#123;BUCKET_NAME&#125;&quot; --acl bucket-owner-full-control --acl public-read --delete --cache-control &quot;max-age=1&quot; --exclude www/assets</div><div class="line">      - aws s3 sync www/assets &quot;s3://$&#123;BUCKET_NAME&#125;/assets&quot; --acl bucket-owner-full-control --acl public-read --delete --cache-control &quot;max-age=31536000&quot;</div><div class="line">  post_build:</div><div class="line">    commands:</div></pre></td></tr></table></figure></p>
<h3 id="Can-you-explain-the-different-parts-of-the-template"><a href="#Can-you-explain-the-different-parts-of-the-template" class="headerlink" title="Can you explain the different parts of the template?"></a>Can you explain the different parts of the template?</h3><p>I thought you’d never ask.  Here goes.</p>
<h4 id="Mappings"><a href="#Mappings" class="headerlink" title="Mappings"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html" target="_blank" rel="external">Mappings</a></h4><p>The mappings section allows you to add data to your template that you’ll need to lookup later…  Like information based on availability zones.  In our case we needed to lookup the S3 hosted zone ID given the availability zone we’re deploying to.  Why doesn’t AWS make this info available by default?  Good question, why not AWS?<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&quot;Mappings&quot;: &#123;</div><div class="line">   &quot;RegionMap&quot;: &#123;</div><div class="line">     &quot;us-east-1&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z3AQBSTGFYJSTF&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-us-east-1.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;us-west-1&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z2F56UZL2M1ACD&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-us-west-1.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;us-west-2&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z3BJ6K6RIION7M&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-us-west-2.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;eu-west-1&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z1BKCTXD74EZPE&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-eu-west-1.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;ap-southeast-1&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z3O0J2DXBE1FTB&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-ap-southeast-1.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;ap-southeast-2&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z1WCIGYICN2BYD&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-ap-southeast-2.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;ap-northeast-1&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z2M4EHUR26P7ZW&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-ap-northeast-1.amazonaws.com&quot;</div><div class="line">     &#125;,</div><div class="line">     &quot;sa-east-1&quot;: &#123;</div><div class="line">       &quot;S3hostedzoneID&quot;: &quot;Z31GFT0UA1I2HV&quot;,</div><div class="line">       &quot;websiteendpoint&quot;: &quot;s3-website-sa-east-1.amazonaws.com&quot;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;,</div></pre></td></tr></table></figure></p>
<h4 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" target="_blank" rel="external">Parameters</a></h4><p>Parameters are optional values that you can pass into your template.  For use we passed in the domain name.  This way we could use this template to setup many different static websites.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&quot;Parameters&quot;: &#123;</div><div class="line">  &quot;ApexDomainName&quot;: &#123;</div><div class="line">    &quot;Description&quot;: &quot;Domain name for your website (example.com)&quot;,</div><div class="line">    &quot;Type&quot;: &quot;String&quot;,</div><div class="line">    &quot;Default&quot;: &quot;example.com&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;AppName&quot;: &#123;</div><div class="line">    &quot;Description&quot;: &quot;App name for your website (example).  Only alphanumeric characters, dash, and underscore are supported.&quot;,</div><div class="line">    &quot;Type&quot;: &quot;String&quot;,</div><div class="line">    &quot;Default&quot;: &quot;example&quot;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<h4 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html" target="_blank" rel="external">Resources</a></h4><p>The set of AWS resources you want to include in the stack.  Lets walk through each resource we used and how they relate to each other.</p>
<h4 id="S3-Bucket"><a href="#S3-Bucket" class="headerlink" title="S3 Bucket"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html" target="_blank" rel="external">S3 Bucket</a></h4><p>First we need to create the S3 buckets</p>
<p>The root bucket hosts our static site at the domain apex (example.com).</p>
<ul>
<li>DeleteionPolicy: <em>Retain</em> -&gt; Don’t delete our bucket when we delete this stack.  </li>
<li>BucketName: <em>{“Ref”:”ApexDomainName”}</em> -&gt; Here we reference the parameter passed in.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&quot;RootBucket&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::S3::Bucket&quot;,</div><div class="line">  &quot;DeletionPolicy&quot;: &quot;Retain&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;BucketName&quot;: &#123;</div><div class="line">      &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;AccessControl&quot;: &quot;PublicRead&quot;,</div><div class="line">    &quot;WebsiteConfiguration&quot;: &#123;</div><div class="line">      &quot;IndexDocument&quot;: &quot;index.html&quot;,</div><div class="line">      &quot;ErrorDocument&quot;: &quot;404.html&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>The www subdomain redirects to our apex domain.</p>
<ul>
<li>Join -&gt; Function that adds ‘www.’ to our apex domain and uses that as the bucket name.</li>
<li>RedirectAllRequestsTo -&gt; Redirect all requests to our apex domain.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&quot;WWWBucket&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::S3::Bucket&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;BucketName&quot;: &#123;</div><div class="line">      &quot;Fn::Join&quot;: [</div><div class="line">        &quot;&quot;,</div><div class="line">        [</div><div class="line">          &quot;www.&quot;,</div><div class="line">          &#123;</div><div class="line">            &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;AccessControl&quot;: &quot;BucketOwnerFullControl&quot;,</div><div class="line">    &quot;WebsiteConfiguration&quot;: &#123;</div><div class="line">      &quot;RedirectAllRequestsTo&quot;: &#123;</div><div class="line">        &quot;HostName&quot;: &#123;</div><div class="line">          &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>We create a dev. subdomain as well. This is where we will do our QA and testing.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&quot;DevBucket&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::S3::Bucket&quot;,</div><div class="line">  &quot;DeletionPolicy&quot;: &quot;Retain&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;BucketName&quot;: &#123;</div><div class="line">      &quot;Fn::Join&quot;: [</div><div class="line">        &quot;&quot;,</div><div class="line">        [</div><div class="line">          &quot;dev.&quot;,</div><div class="line">          &#123;</div><div class="line">            &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;AccessControl&quot;: &quot;PublicRead&quot;,</div><div class="line">    &quot;WebsiteConfiguration&quot;: &#123;</div><div class="line">      &quot;IndexDocument&quot;: &quot;index.html&quot;,</div><div class="line">      &quot;ErrorDocument&quot;: &quot;404.html&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>The ArtifactBucket is needed by CodePipeline during the continuous deployments<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&quot;ArtifactBucket&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::S3::Bucket&quot;,</div><div class="line">  &quot;DeletionPolicy&quot;: &quot;Delete&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;AccessControl&quot;: &quot;Private&quot;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<h4 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-certificatemanager-certificate.html" target="_blank" rel="external">SSL</a></h4><p>We need to create an SSL certificate to use with our apex domain.  Pretty cool that AWS gives us a free SSL cert and cycles them for us when they expire.  No more are they days of creating our own Certificate Request and sending it to GoDaddy.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&quot;SSL&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::CertificateManager::Certificate&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;DomainName&quot;: &#123;</div><div class="line">      &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;SubjectAlternativeNames&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;Fn::Join&quot;: [</div><div class="line">          &quot;&quot;,</div><div class="line">          [</div><div class="line">            &quot;www.&quot;,</div><div class="line">            &#123;</div><div class="line">              &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h4 id="CloudFront"><a href="#CloudFront" class="headerlink" title="CloudFront"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distribution.html" target="_blank" rel="external">CloudFront</a></h4><p>We use a Content Delivery Network (CDN) for two reasons:</p>
<ul>
<li>It caches our web assets, html, css, js, and image files <em>at the edge</em></li>
<li>It handles our SSL certificate and termination</li>
</ul>
<p>Our source is the apex S3 website.  Besides the default behavior we added two additional behaviors for .js and .css files.  For these files we want to use the query params within the cache key.  I like to cache these files for a really long time.  The only catch is that when you make changes to these files you have to add a version query param to the url when you request them in your html pages.  Ex.  /css/app.css?v=2.  It is a good practice to just dynamically change this version every time you deploy.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">&quot;CDN&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::CloudFront::Distribution&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;DistributionConfig&quot;: &#123;</div><div class="line">      &quot;Aliases&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      &quot;Enabled&quot;: true,</div><div class="line">      &quot;PriceClass&quot;: &quot;PriceClass_All&quot;,</div><div class="line">      &quot;CacheBehaviors&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;TargetOriginId&quot;: &#123;</div><div class="line">            &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;PathPattern&quot;: &quot;*.js&quot;,</div><div class="line">          &quot;ViewerProtocolPolicy&quot;: &quot;redirect-to-https&quot;,</div><div class="line">          &quot;MinTTL&quot;: 0,</div><div class="line">          &quot;AllowedMethods&quot;: [</div><div class="line">            &quot;HEAD&quot;,</div><div class="line">            &quot;GET&quot;</div><div class="line">          ],</div><div class="line">          &quot;CachedMethods&quot;: [</div><div class="line">            &quot;HEAD&quot;,</div><div class="line">            &quot;GET&quot;</div><div class="line">          ],</div><div class="line">          &quot;ForwardedValues&quot;: &#123;</div><div class="line">            &quot;QueryString&quot;: true,</div><div class="line">            &quot;Cookies&quot;: &#123;</div><div class="line">              &quot;Forward&quot;: &quot;none&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;TargetOriginId&quot;: &#123;</div><div class="line">            &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;PathPattern&quot;: &quot;*.css&quot;,</div><div class="line">          &quot;ViewerProtocolPolicy&quot;: &quot;redirect-to-https&quot;,</div><div class="line">          &quot;MinTTL&quot;: 0,</div><div class="line">          &quot;AllowedMethods&quot;: [</div><div class="line">            &quot;HEAD&quot;,</div><div class="line">            &quot;GET&quot;</div><div class="line">          ],</div><div class="line">          &quot;CachedMethods&quot;: [</div><div class="line">            &quot;HEAD&quot;,</div><div class="line">            &quot;GET&quot;</div><div class="line">          ],</div><div class="line">          &quot;ForwardedValues&quot;: &#123;</div><div class="line">            &quot;QueryString&quot;: true,</div><div class="line">            &quot;Cookies&quot;: &#123;</div><div class="line">              &quot;Forward&quot;: &quot;none&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      &quot;DefaultCacheBehavior&quot;: &#123;</div><div class="line">        &quot;TargetOriginId&quot;: &#123;</div><div class="line">          &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;ViewerProtocolPolicy&quot;: &quot;redirect-to-https&quot;,</div><div class="line">        &quot;MinTTL&quot;: 0,</div><div class="line">        &quot;AllowedMethods&quot;: [</div><div class="line">          &quot;HEAD&quot;,</div><div class="line">          &quot;GET&quot;</div><div class="line">        ],</div><div class="line">        &quot;CachedMethods&quot;: [</div><div class="line">          &quot;HEAD&quot;,</div><div class="line">          &quot;GET&quot;</div><div class="line">        ],</div><div class="line">        &quot;ForwardedValues&quot;: &#123;</div><div class="line">          &quot;QueryString&quot;: false,</div><div class="line">          &quot;Cookies&quot;: &#123;</div><div class="line">            &quot;Forward&quot;: &quot;none&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;Origins&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;DomainName&quot;: &#123;</div><div class="line">            &quot;Fn::Join&quot;: [</div><div class="line">              &quot;.&quot;,</div><div class="line">              [</div><div class="line">                &#123;</div><div class="line">                  &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  &quot;Fn::FindInMap&quot;: [</div><div class="line">                    &quot;RegionMap&quot;,</div><div class="line">                    &#123;</div><div class="line">                      &quot;Ref&quot;: &quot;AWS::Region&quot;</div><div class="line">                    &#125;,</div><div class="line">                    &quot;websiteendpoint&quot;</div><div class="line">                  ]</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            ]</div><div class="line">          &#125;,</div><div class="line">          &quot;Id&quot;: &#123;</div><div class="line">            &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;CustomOriginConfig&quot;: &#123;</div><div class="line">            &quot;HTTPPort&quot;: &quot;80&quot;,</div><div class="line">            &quot;HTTPSPort&quot;: &quot;443&quot;,</div><div class="line">            &quot;OriginProtocolPolicy&quot;: &quot;http-only&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      &quot;Restrictions&quot;: &#123;</div><div class="line">        &quot;GeoRestriction&quot;: &#123;</div><div class="line">          &quot;RestrictionType&quot;: &quot;none&quot;,</div><div class="line">          &quot;Locations&quot;: [</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;ViewerCertificate&quot;: &#123;</div><div class="line">        &quot;SslSupportMethod&quot;: &quot;sni-only&quot;,</div><div class="line">        &quot;MinimumProtocolVersion&quot;: &quot;TLSv1&quot;,</div><div class="line">        &quot;AcmCertificateArn&quot;: &#123;</div><div class="line">          &quot;Ref&quot;: &quot;SSL&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h4 id="Route53"><a href="#Route53" class="headerlink" title="Route53"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-recordset.html" target="_blank" rel="external">Route53</a></h4><p>We need to create 3 DNS routes.  </p>
<ul>
<li>Apex domain -&gt; CloudFront</li>
<li>www sub domain -&gt; www S3 endpoint so S3 does the redirect to Apex</li>
<li>dev sub domain -&gt; straight to the dev S3 endpoint.  No caching, no SSL</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line">&quot;DNS&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::Route53::RecordSetGroup&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;HostedZoneName&quot;: &#123;</div><div class="line">      &quot;Fn::Join&quot;: [</div><div class="line">        &quot;&quot;,</div><div class="line">        [</div><div class="line">          &#123;</div><div class="line">            &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;.&quot;</div><div class="line">        ]</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;Comment&quot;: &quot;Zone apex alias.&quot;,</div><div class="line">    &quot;RecordSets&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;Name&quot;: &#123;</div><div class="line">          &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;Type&quot;: &quot;A&quot;,</div><div class="line">        &quot;AliasTarget&quot;: &#123;</div><div class="line">          &quot;HostedZoneId&quot;: &quot;Z2FDTNDATAQYW2&quot;,</div><div class="line">          &quot;DNSName&quot;: &#123;</div><div class="line">            &quot;Fn::GetAtt&quot;: [</div><div class="line">              &quot;CDN&quot;,</div><div class="line">              &quot;DomainName&quot;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;Name&quot;: &#123;</div><div class="line">          &quot;Fn::Join&quot;: [</div><div class="line">            &quot;&quot;,</div><div class="line">            [</div><div class="line">              &quot;www.&quot;,</div><div class="line">              &#123;</div><div class="line">                &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        &quot;Type&quot;: &quot;CNAME&quot;,</div><div class="line">        &quot;TTL&quot;: &quot;900&quot;,</div><div class="line">        &quot;ResourceRecords&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;Fn::Join&quot;: [</div><div class="line">              &quot;.&quot;,</div><div class="line">              [</div><div class="line">                &quot;www&quot;,</div><div class="line">                &#123;</div><div class="line">                  &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  &quot;Fn::FindInMap&quot;: [</div><div class="line">                    &quot;RegionMap&quot;,</div><div class="line">                    &#123;</div><div class="line">                      &quot;Ref&quot;: &quot;AWS::Region&quot;</div><div class="line">                    &#125;,</div><div class="line">                    &quot;websiteendpoint&quot;</div><div class="line">                  ]</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;Name&quot;: &#123;</div><div class="line">          &quot;Fn::Join&quot;: [</div><div class="line">            &quot;&quot;,</div><div class="line">            [</div><div class="line">              &quot;dev.&quot;,</div><div class="line">              &#123;</div><div class="line">                &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        &quot;Type&quot;: &quot;CNAME&quot;,</div><div class="line">        &quot;TTL&quot;: &quot;900&quot;,</div><div class="line">        &quot;ResourceRecords&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;Fn::Join&quot;: [</div><div class="line">              &quot;.&quot;,</div><div class="line">              [</div><div class="line">                &quot;dev&quot;,</div><div class="line">                &#123;</div><div class="line">                  &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  &quot;Fn::FindInMap&quot;: [</div><div class="line">                    &quot;RegionMap&quot;,</div><div class="line">                    &#123;</div><div class="line">                      &quot;Ref&quot;: &quot;AWS::Region&quot;</div><div class="line">                    &#125;,</div><div class="line">                    &quot;websiteendpoint&quot;</div><div class="line">                  ]</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h4 id="CodeCommit"><a href="#CodeCommit" class="headerlink" title="CodeCommit"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codecommit-repository.html" target="_blank" rel="external">CodeCommit</a></h4><p>Now we need to create our GIT repo.  We’ll use our GIT repo to trigger CodePipeline and CodeBuild to perform our continuous deployments on checkin.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&quot;GIT&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::CodeCommit::Repository&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;RepositoryDescription&quot;: &#123;</div><div class="line">      &quot;Fn::Join&quot;: [</div><div class="line">        &quot; &quot;,</div><div class="line">        [</div><div class="line">          &#123;</div><div class="line">            &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;Code Repository&quot;</div><div class="line">        ]</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;RepositoryName&quot;: &#123;</div><div class="line">      &quot;Ref&quot;: &quot;ApexDomainName&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h4 id="CodeBuild"><a href="#CodeBuild" class="headerlink" title="CodeBuild"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html" target="_blank" rel="external">CodeBuild</a></h4><p>The CodeBuild is the thing that actually uploads our website into S3.  CodePipeline will hand CodeBuild all the files in the GIT repo and CodeBuild does its thing…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&quot;CodeBuildRoot&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::CodeBuild::Project&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;Artifacts&quot;: &#123;</div><div class="line">      &quot;Type&quot;: &quot;CODEPIPELINE&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;Environment&quot;: &#123;</div><div class="line">      &quot;ComputeType&quot;: &quot;BUILD_GENERAL1_SMALL&quot;,</div><div class="line">      &quot;Image&quot;: &quot;aws/codebuild/ubuntu-base:14.04&quot;,</div><div class="line">      &quot;Type&quot;: &quot;LINUX_CONTAINER&quot;,</div><div class="line">      &quot;EnvironmentVariables&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;Name&quot;: &quot;BUCKET_NAME&quot;,</div><div class="line">          &quot;Value&quot;: &#123;</div><div class="line">            &quot;Ref&quot;: &quot;RootBucket&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;Name&quot;: &#123;</div><div class="line">      &quot;Fn::Join&quot;: [</div><div class="line">        &quot;_&quot;,</div><div class="line">        [</div><div class="line">          &#123;</div><div class="line">            &quot;Ref&quot;: &quot;AppName&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;Root_Build&quot;</div><div class="line">        ]</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;ServiceRole&quot;: &#123;</div><div class="line">      &quot;Ref&quot;: &quot;CodeBuildRole&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;Source&quot;: &#123;</div><div class="line">      &quot;Type&quot;: &quot;CODEPIPELINE&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;TimeoutInMinutes&quot;: 10</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>CodeBuild uses a <em>buildspec.yml</em> to perform the build.  Here is our buildspec.yml  This file has to be in the root of your project repo.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">version: 0.1</div><div class="line">phases:</div><div class="line">  install:</div><div class="line">    commands:</div><div class="line">  pre_build:</div><div class="line">    commands:</div><div class="line">  build:</div><div class="line">    commands:</div><div class="line">      - aws s3 sync www &quot;s3://$&#123;BUCKET_NAME&#125;&quot; --acl bucket-owner-full-control --acl public-read --delete --cache-control &quot;max-age=1&quot; --exclude www/assets</div><div class="line">      - aws s3 sync www/assets &quot;s3://$&#123;BUCKET_NAME&#125;/assets&quot; --acl bucket-owner-full-control --acl public-read --delete --cache-control &quot;max-age=31536000&quot;</div><div class="line">  post_build:</div><div class="line">    commands:</div></pre></td></tr></table></figure></p>
<h4 id="CodePipeline"><a href="#CodePipeline" class="headerlink" title="CodePipeline"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-pipeline.html" target="_blank" rel="external">CodePipeline</a></h4><p>Our CodePipeline has two stages.  </p>
<ul>
<li>The first stage is triggered by a GIT push to the <em>master</em> branch of our repo.  This stage simply hands the next stage all the files in our repo.</li>
<li>The second stage is our CodeBuild which runs the buildspec.yml and uploads all the files to S3.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">&quot;CodePipelineRoot&quot;: &#123;</div><div class="line">  &quot;Type&quot;: &quot;AWS::CodePipeline::Pipeline&quot;,</div><div class="line">  &quot;Properties&quot;: &#123;</div><div class="line">    &quot;RoleArn&quot;: &#123;</div><div class="line">      &quot;Fn::GetAtt&quot;: [</div><div class="line">        &quot;CodePipelineRole&quot;,</div><div class="line">        &quot;Arn&quot;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;Stages&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;Name&quot;: &quot;Source&quot;,</div><div class="line">        &quot;Actions&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;Name&quot;: &quot;SourceAction&quot;,</div><div class="line">            &quot;ActionTypeId&quot;: &#123;</div><div class="line">              &quot;Category&quot;: &quot;Source&quot;,</div><div class="line">              &quot;Owner&quot;: &quot;AWS&quot;,</div><div class="line">              &quot;Version&quot;: &quot;1&quot;,</div><div class="line">              &quot;Provider&quot;: &quot;CodeCommit&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;OutputArtifacts&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;Name&quot;: &quot;StaticSiteSource&quot;</div><div class="line">              &#125;</div><div class="line">            ],</div><div class="line">            &quot;Configuration&quot;: &#123;</div><div class="line">              &quot;BranchName&quot;: &quot;master&quot;,</div><div class="line">              &quot;RepositoryName&quot;: &#123;</div><div class="line">                &quot;Fn::GetAtt&quot;: [</div><div class="line">                  &quot;GIT&quot;,</div><div class="line">                  &quot;Name&quot;</div><div class="line">                ]</div><div class="line">              &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;RunOrder&quot;: 1</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;Name&quot;: &quot;Build&quot;,</div><div class="line">        &quot;Actions&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;Name&quot;: &quot;BuildRoot&quot;,</div><div class="line">            &quot;InputArtifacts&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;Name&quot;: &quot;StaticSiteSource&quot;</div><div class="line">              &#125;</div><div class="line">            ],</div><div class="line">            &quot;ActionTypeId&quot;: &#123;</div><div class="line">              &quot;Category&quot;: &quot;Build&quot;,</div><div class="line">              &quot;Owner&quot;: &quot;AWS&quot;,</div><div class="line">              &quot;Version&quot;: &quot;1&quot;,</div><div class="line">              &quot;Provider&quot;: &quot;CodeBuild&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;Configuration&quot;: &#123;</div><div class="line">              &quot;ProjectName&quot;: &#123;</div><div class="line">                &quot;Ref&quot;: &quot;CodeBuildRoot&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;RunOrder&quot;: 1</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    &quot;ArtifactStore&quot;: &#123;</div><div class="line">      &quot;Type&quot;: &quot;S3&quot;,</div><div class="line">      &quot;Location&quot;: &#123;</div><div class="line">        &quot;Ref&quot;: &quot;ArtifactBucket&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h4 id="Outputs"><a href="#Outputs" class="headerlink" title="Outputs"></a><a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html" target="_blank" rel="external">Outputs</a></h4><p>Send information to the outputs section of this stack so we can easily access it.  In this case we need the CodeCommit repo url so we can start coding.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&quot;Outputs&quot;: &#123;</div><div class="line">  &quot;WebsiteURL&quot;: &#123;</div><div class="line">    &quot;Value&quot;: &#123;</div><div class="line">      &quot;Fn::GetAtt&quot;: [</div><div class="line">        &quot;GIT&quot;,</div><div class="line">        &quot;CloneUrlHttp&quot;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;Description&quot;: &quot;CodeCommit URL&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="https://media.licdn.com/mpr/mpr/shrinknp_400_400/p/3/005/062/05d/36bc6ef.jpg" alt="avatar" />
    <div class="grid-item">
      <p class="title"> Randy Findley </p>
      <p class="subtitle"> An Engineering Blog </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="rgfindl"
  href="https://twitter.com/intent/tweet?text=The template: <a hre"
>

</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'rgfindl-github-io';
  
  var disqus_url = 'https://rgfindl.github.io/2017/08/07/static-website-cloudformation-template/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
